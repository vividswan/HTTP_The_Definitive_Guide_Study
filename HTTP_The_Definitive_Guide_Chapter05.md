# 5장 - 웹 서버

- 웹 서버는 월드 와이드 웹의 일꾼

## 5.1 다채로운 웹 서버

- 웹 서버 : 웹 서버 소프트웨어 + 웹페이지 제공에 특화된 장비
- 웹 서버는 기능, 형태, 크기가 다양
  - 모두 리소스에 대한 HTTP 요청을 받아서 콘텐츠를 클라이언트에게 돌려줌

### 5.1.1 웹 서버 구현

- 웹 서버는 HTTP 및 그와 관련된 TCP 처리를 구현 및 관리 기능 제공
- 운영체제와 TCP 커넥션 관리에 대한 책임을 나눠 가짐
- 여러 가지 형태의 웹 서버
  - 다목적 소프트웨어 웹 서버
  - 전자기기 안에 칩만으로 구현된 웹 서버

### 5.1.2 다목적 소프트웨어 웹 서버

- 네트워크에 연결된 표준 컴퓨터 시스템에서 동작
  - 아파치, W3C, 마이크로소프트나 아이플래닛의 웹 서버
  - 거의 모든 컴퓨터와 운영체제에서 동작

### 5.1.3 임베디드 웹 서버

- 일반 소비자용 제품에 내장될 목적으로 만들어진 작은 웹 서버
  - 간편한 웹 브라우저 인터페이스로 관리할 수 있게 해줌

## 5.2 간단한 펄 웹 서버

- 최소한의 기능의 HTTP 서버는 30줄 이하의 펄 코드로 만들 수 있음
  - type-o-server 예제 (클라이언트와 프락시 간의 상호작용 테스트 진단 툴)

## 5.3 진짜 웹 서버가 하는 일

- 웹 서버가 공통적으로 하는 일들
  1. 커넥션을 맺음 (원치 않는 클라이언트는 닫음)
  2. 요청을 받음 (HTTP 요청 메시지를 네트워크로부터 읽어 들임)
  3. 요청을 처리
  4. 메서드에서 지정한 리소스에 접근
  5. 응답을 만듦 (헤더를 포함한 HTTP 응답 메서드)
  6. 응답을 보냄 (클라이언트에게 돌려줌)
  7. 트랜잭션을 로그로 남김

## 5.4 단계 1:클라이언트 커넥션 수락

- 지속적 커넥션이 없을 시 새 커넥션을 열어야 함

### 5.4.1 새 커넥션 다루기

- 클라이언트가 웹 서버에 TCP 커넥션 요청 후 웹 서버는 커넥션을 맺음
  - TCP 커넥션에서 IP를 추출 후 클라이언트를 확인
  - 커넥션 목록에 새 커넥션을 추가
- IP 주소나 호스트명이 인가되지 않았거나 악의적이면 커넥션을 즉시 닫을 수 있음

### 5.4.2 클라이언트 호스트 명 식별

- `역방향 DNS(reverse DNS)`
  - 클라이언트의 IP 주소를 클라이언트의 호스트명으로 변환
- 클라이언트의 호스트 명을 접근 제어와 로깅을 위해 사용
- 호스트 명 룩업은 꽤 많은 시간이 걸리므로 꺼두거나 특정 콘텐츠에 대해서만 켜둘 수 있음

### 5.4.3 ident를 통해 클라이언트 사용자 알아내기

- IETF ident는 서버에게 어떤 사용자 이름이 HTTP 커넥션을 초기화했는지 찾아낼 수 있게 해줌
  - 서버 로깅에서 유용
  - 클라이언트가 지원해 준다면 TCP 포트 113번을 listen
- 여러 이유로 잘 동작하지 않음

## 5.5 단계 2: 요청 메시지 수신

- 웹 서버는 도착한 데이터를 커넥션에서 읽어들이고 파싱 후 요청 메시지 구성
- 요청 줄, 메시지 헤더들, 본문이 있다면 본문을 서버에서 읽어 드림
- 입력 데이터를 네트워크로부터 불규칙적으로 받음
  - 파싱 후 이해 가능한 수준까지 확보를 위해 메시지 일부분을 임시로 저장해둘 필요가 있음

### 5.5.1 메시지의 내부 표현

- 몇몇 웹서버는 요청 메시지를 쉽게 다루기 위해 내부 자료 구조에 저장
  - 각 조각에 대한 포인터와 길이 등을 담아서 저장

### 5.5.2 커넥션 입력/출력 처리 아키텍처

- 웹 서버는 수천 개의 커넥션을 동시에 열 수 있도록 지원
- 커넥션들로부터 들어오는 요청의 속도나 상태가 다름
- 웹 서버는 항상 새 요청을 주시
- 단일 스레드 웹 서버
  - 한 번에 하나씩 요청을 처리
  - 간단한 구현
  - 처리 도중 다른 커넥션은 무시 (성능 문제 야기)
- 멀티프로세스와 멀티스레드 웹 서버
  - 여러 개의 프로세스나 고효율 스레드를 할당하여 여러 요청을 동시에 처리
  - 미리 만들어 놓거나 필요할 때마다 만들 수 있음
  - 무리한 시스템 리소스 소비를 막기 위해 최대 개수에 제한을 걸음
- 다중 I/O 서버
  - 모든 커넥션이 동시에 그 활동을 감시
  - 커넥션의 상태가 바뀔 때만 적은 양의 처리가 수행
  - 처리가 완료 후 열린 커넥션 목록으로 돌아감
  - 유휴 상태의 커넥션에 매여 기다리지 않음
- 다중 멀티스레드 웹 서버
  - 여러 개의 스레드가 각각 열려있는 커넥션을 감시하고 각 커넥션에 대해 조금씩 작업 수행

## 5.6 단계 3: 요청 처리

- 서버는 요청으로부터 메서드, 리소스, 헤더, 본문(없는 경우도 있음)을 얻어내어 처리
- 요청 메시지에 엔터티 본문을 요구하거나, 허용하되 요구하지 않거나 금지하는 메서드도 존재

## 5.7 단계 4: 리소스의 매핑과 접근

- 웹 서버는 미리 만들어진 콘텐츠나 동적 콘텐츠를 클라이언트에게 제공
- 웹 서버가 클라이언트에게 콘텐츠를 제공하기 위해 콘텐츠의 원천을 식별해야 함

### 5.7.1 Docroot

- docroot
  - 웹 서버 파일 시스템의 특별한 폴더를 웹 콘텐츠를 위해 예약해 둔 것
  - 웹 서버는 요청 메시지에서 URI를 가져와서 문서 루트 뒤에 붙임
- 아파치 웹 서버에선 httped.conf 설정 파일의 DocumentRoot 줄을 추가하여 문서 루트 설정 가능
- 상대적 url이 docroot를 벗어나서 docroot 이외 부분이 노출되는 일이 생기지 않도록 주의
- 가상 호스팅 된 docroot
  - 가상 호스팅 웹서버는 URI나 Host 헤더에서 얻은 IP 주소나 호스트 명을 이용해 문서 루트를 식별하여 하나의 웹 서버 위에서 분리된 콘텐츠를 갖고 호스팅 되도록 할 수 있음
  - 아파치에선 VirtualHost 블록에서 가상 서버에 대한 DocumentRoot 지시자로 설정할 수 있음
- 사용자 홈 디렉터리 docroots
  - docroot의 또 다른 대표적인 활용
  - 사용자들이 한 대의 웹 서버에서 각자의 개인 웹 사이트를 만들 수 있음
  - 빗금(/)과 물결표(~) 다음에 사용자 이름이 오는 것으로 시작하는 URI로 사용자 개인 무서 루트를 가리킴
  - 주로 사용자 홈 디렉터리 안에 있는 public_html로 불리는 디렉터리

### 5.7.2 디렉터리 목록

- 웹 서버가 디렉터리 URL에 대한 요청을 받았을 때
  - 에러를 반환
  - 디렉터리 대신 특별한 '색인 파일' 반환
  - 디렉터리르 탐색해서 그 내용을 담은 HTML 페이지 반환
- 일반적으로 index.html or index.htm 파일을 반환
- 아파치의 경우 DirectoryIndex 설정 지시자를 사용해서 기본 디렉터리 파일로 사용될 파일 이름의 집합 정의
  - 색인 파일로 사용될 모든 파일의 우선순위 나열
- 기본 파일이 없고 색인 기능이 켜져 있을 시 그 디렉터리의 파일들을 크기, 변경일, 파일에 대한 링크와 함께 열거한 HTML 반환
  - 편리하기는 하나 일반적으로는 발견할 수 없는 파일 노출
  - `Options -Indexes`로 디렉터리 색인 파일 자동 생성을 끌 수 있다.

### 5.7.3 동적 콘텐츠 리소스 매핑

- 애플리케이션 서버
  - 웹 서버를 복잡한 백엔드 애플리케이션과 연결하는 일을 함
  - 동적 리소스를 요청받으면 그에 대한 동적 콘텐츠 생성 프로그램을 찾아주고 어떻게 실행하는지 알려줌
- 아파치의 경우 URI의 경로명이 실행 가능한 프로그램이 위치한 디렉터리로 매핑 되도록 설정 가능
- 또한 아파치는 특정 확장자의 파일만 실행하도록 설정 가능

### 5.7.4 서버사이드 인클루드(Server-Side Includes, SSI)

- 리소스가 서버사이드 인클루드를 포함하고 있을 시 리소스의 콘텐츠를 클라이언트에게 보내기 전에 서버에서 처리
- 서버가 콘텐츠의 특별한 패턴을 변숫값이나 실행 가능한 스크립트의 출력값으로 치환

### 5.7.5 접근 제어

- 웹 서버는 각각의 리소스에 접근 제어를 할당 가능
  - 클라이언트의 IP 주소에 근거하거나 접근하기 위한 비밀번호를 물어볼 수 있다.

## 5.8 단계 5: 응답 만들기

- 응답 메시지는 응답 상태 코드, 응답 헤더, 응답 본문(생성되었을 시)을 포함

### 5.8.1 응답 엔터티

- 본문이 있을 시 응답 메시지가 포함하는 것
  - Content-Type 헤더 : 응답 본문의 MIME 타입 서술
  - Content-Length 헤더 : 응답 본문의 길이를 서술
  - 실제 응답 본문의 내용

### 5.8.2 MIME 타입 결정하기

- MIME 타입과 리소스를 연결하는 여러 가지 방법
  - mime.types : 파일 이름의 확장자를 사용
  - 매직 타이핑(Magic typing) : 파일의 내용을 검사 후 알려진 패턴에 대한 테이블(매직 파일)에 해당하는 패턴을 찾음 (느리긴 하지만 편리)
  - 유형 명시(Explicit typing) : 특정 파일이나 디렉터리 안의 파일들이 파일 확장자나 내용에 상관없이 어떤 MIME 타입을 갖도록 웹 서버를 설정
  - 유형 협상(Type negotiation) : 웹 서버가 사용자와의 협상 과정을 통해 사용하기 가장 좋은 형식을 판별

### 5.8.3 리다이렉션

- 웹 서버는 요청 수행을 위해 브라우저가 다른 곳으로 가도록 리다이렉트 가능
- 3XX 상태 코드로 지칭
- 새로운 혹은 선호하는 위치에 대한 URI를 포함해서 Location 응답 헤더에 실음
- 리다이렉트가 유용한 경우
  - 영구히 리소스가 옮겨진 경우 : `301 Moved Permanently` 사용, 리소스에 새 URL이 부여된 경우
  - 임시로 리소스가 옮겨진 경우 : 임시적인 변경이므로 원래 URL을 찾아오고 북마크도 갱신을 원하지 않을 때 (`303 See Other`, `307 Temporary Redirect` 사용)
  - URL 증강 : 종종 문맥 정보를 포함시키기 위해 재 작성된 URL로 리다이렉트, 상태 정보를 내포한 새 URL을 서버에서 생성하고 사용자가 그 URL로 리다이렉트 (`303 See Other`, `307 Temporary Redirect` 사용)
  - 부하 균형 : 과부하 된 서버가 요청을 받으면 부하가 좀 덜 걸린 서버로 리다이렉트 (`303 See Other`, `307 Temporary Redirect` 사용)
  - 친밀한 다른 서버가 있을 때 : 서버가 클라이언트에 대한 정보를 갖고 있을 때 그 정보를 갖고 있는 서버로 리다이렉트 (`303 See Other`, `307 Temporary Redirect` 사용)
  - 디렉터리 이름 정규화 : URI 요청에 빗금(/)을 빠뜨렸다면 정상적으로 동작하도록 슬래시를 추가한 URI로 리다이렉트 함

## 5.9 단계 6: 응답 보내기

- 서버는 여러 클라이언트에 대한 많은 커넥션을 가짐
- 지속적인 커넥션은 특별히 주의해서 다룰 것
  - 비지속적인 커넥션은 메시지 전송 후 자신의 커넥션을 닫음
  - 지속적인 커넥션이라면 특별히 주의가 필요한 경우나 응답이 언제 끝나는지 알 수 없는 경우에 커넥션을 열린 상태로 유지

## 5.10 단계 7: 로깅

- 트랜잭션 완료 후 웹 서버는 트랜잭션 수행 내용 로그를 로그파일에 기록
- 대부분의 웹 서버는 로깅에 대한 여러 가지 설정 양식을 제공
